<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>LingoGames ‚Äî Word Runner</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#070A12;
      --fg: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.64);
      --glass: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --good: rgba(34,197,94,.95);
      --bad: rgba(239,68,68,.95);
      --a1: rgba(99,102,241,.95);
      --a2: rgba(236,72,153,.85);
      --shadow: 0 30px 90px rgba(0,0,0,.55);
      --r: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--fg);
      background:
        radial-gradient(1200px 800px at 12% 10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(900px 700px at 88% 20%, rgba(236,72,153,.18), transparent 62%),
        radial-gradient(900px 700px at 50% 100%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, #050611, #0A1024 55%, #070A12);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      overflow:hidden;
    }

    .wrap{ width:min(440px, 100%); position:relative; }
    .blob{
      position:absolute; width:240px; height:240px; border-radius:999px;
      filter: blur(30px); opacity:.35; pointer-events:none; mix-blend-mode: screen;
      animation: drift 10s ease-in-out infinite;
    }
    .b1{ background: rgba(99,102,241,.55); top:-90px; left:-80px; }
    .b2{ background: rgba(236,72,153,.45); bottom:-100px; right:-90px; animation-delay:-3s;}
    @keyframes drift{ 0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(18px,14px) scale(1.06)} }

    .top{
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      margin-bottom: 10px;
    }
    .pill{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px; border-radius: 999px;
      background: rgba(255,255,255,.07);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 50px rgba(0,0,0,.22);
      min-width: 0;
    }
    .icon{
      width:30px; height:30px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .k{ font-size:12px; color: var(--muted); line-height:1.1; }
    .v{ font-weight: 900; font-size: 14px; letter-spacing:.2px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btnGhost{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .2s ease;
      flex: 0 0 auto;
    }
    .btnGhost:active{ transform: scale(.98); background: rgba(255,255,255,.10); }

    .card{
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .head{
      padding: 14px 14px 10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
    }
    .title h1{
      margin:0; font-size: 18px; letter-spacing:.2px;
    }
    .sub{ margin-top:4px; font-size:12px; color: var(--muted); }

    .badge{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .badge b{ color: var(--fg); }

    .goal{
      padding: 0 14px 12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      color: var(--muted); font-size: 12px;
    }
    .bar{
      height: 10px; border-radius:999px; overflow:hidden;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      position:relative;
      flex: 1 1 auto;
    }
    .bar i{
      display:block; height:100%; width: 20%;
      background: linear-gradient(90deg, var(--a1), var(--a2));
      border-radius:999px;
      box-shadow: 0 0 18px rgba(99,102,241,.35);
      transition: width .25s ease;
    }

    .arena{
      position:relative;
      height: 420px;
      background: radial-gradient(900px 420px at 50% 100%, rgba(0,0,0,.40), transparent 65%);
      border-top: 1px solid rgba(255,255,255,.10);
      border-bottom: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      touch-action: manipulation;
    }

    .hudNum{
      position:absolute;
      left: 14px; top: 14px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      z-index: 3;
      min-width: 120px;
    }
    .hudNum .k{ font-size:11px; }
    .hudNum .big{
      margin-top:4px;
      font-size: 44px;
      font-weight: 950;
      letter-spacing: .4px;
      text-shadow: 0 10px 40px rgba(0,0,0,.35);
      line-height:1;
    }

    .laneHint{
      position:absolute;
      right: 14px; top: 14px;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      z-index: 3;
      color: var(--muted);
      font-size: 12px;
      max-width: 180px;
      line-height:1.25;
    }

    .tile{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      width: min(360px, calc(100% - 28px));
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.30);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .tile b{ font-size: 16px; letter-spacing:.2px; }
    .tile .tag{
      font-size: 12px;
      color: rgba(255,255,255,.75);
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .tile.good{
      background: rgba(34,197,94,.14);
      border-color: rgba(34,197,94,.30);
    }
    .tile.bad{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.30);
    }

    .rail{
      position:absolute; left:0; right:0; bottom:0; height: 90px;
      display:flex; gap:10px; padding: 12px 14px;
      align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.42));
      z-index: 2;
    }
    .power{
      flex: 1 1 0;
      border-radius: 18px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, background .2s ease, opacity .2s ease;
      min-width: 0;
    }
    .power:active{ transform: scale(.98); }
    .power .name{ font-weight: 900; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .power .cnt{ font-weight: 950; font-size: 14px; }
    .power.disabled{ opacity:.45; cursor:not-allowed; }
    .power small{ color: var(--muted); font-size: 11px; display:block; margin-top:2px; }

    .bottom{
      padding: 12px 14px 14px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      color: var(--muted); font-size: 12px;
    }
    .stat{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .stat b{ color: var(--fg); }

    .toast{
      position:absolute; left:50%; top: 52%;
      transform: translate(-50%,-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.34);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 90px rgba(0,0,0,.40);
      font-weight: 950;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 5;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; transform: translate(-50%,-60%); }

    .modalBack{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:flex-end; justify-content:center;
      padding: 14px; padding-bottom: calc(14px + env(safe-area-inset-bottom));
      z-index: 20;
    }
    .modalBack.show{ display:flex; }
    .modal{
      width: min(440px, 100%);
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 16px 16px 10px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .modalHead h2{ margin:0; font-size: 16px; }
    .x{
      width: 38px; height: 38px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--fg);
      cursor:pointer;
    }
    .modalBody{
      padding: 0 16px 16px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }
    .plans{ display:grid; gap:10px; margin: 12px 0; }
    .plan{
      padding: 12px 12px; border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .plan b{ color: var(--fg); }
    .cta{
      width:100%;
      border:none; cursor:pointer;
      padding: 14px 14px; border-radius: 16px;
      font-weight: 950; color: rgba(255,255,255,.95);
      background: linear-gradient(90deg, var(--a1), var(--a2));
      box-shadow: 0 18px 60px rgba(99,102,241,.35);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="blob b1"></div><div class="blob b2"></div>

    <div class="top">
      <div class="pill">
        <div class="icon">üî•</div>
        <div>
          <div class="k">–ö–æ–º–±–æ</div>
          <div class="v"><span id="combo">0</span> ‚Ä¢ x<span id="mult">1</span></div>
        </div>
      </div>

      <button class="btnGhost" id="soundBtn">üîä</button>

      <div class="pill">
        <div class="icon">üèÅ</div>
        <div>
          <div class="k">–û—á–∫–∏</div>
          <div class="v"><span id="score">0</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div class="title">
          <h1>üá´üá∑ Word Runner</h1>
          <div class="sub">–õ–æ–≤–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ –ø–æ–¥ —á–∏—Å–ª–æ. –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ ‚Äî —Ç–µ–º –∂–∏—Ä–Ω–µ–µ –∫–æ–º–±–æ.</div>
        </div>
        <div class="badge">üéØ –°–µ—Ä–∏—è –¥–Ω—è: <b id="dailyBest">0</b></div>
      </div>

      <div class="goal">
        <span>–î–æ ‚Äú–±–æ—Å—Å–∞‚Äù –æ—Å—Ç–∞–ª–æ—Å—å: <b id="toBoss">5</b></span>
        <div class="bar"><i id="bossBar"></i></div>
      </div>

      <div class="arena" id="arena">
        <div class="hudNum">
          <div class="k">–ü–µ—Ä–µ–≤–µ–¥–∏ —á–∏—Å–ª–æ</div>
          <div class="big" id="targetNum">3</div>
        </div>
        <div class="laneHint" id="hint">–¢–∞–ø–Ω–∏ –ø–ª–∏—Ç–∫—É —Å–æ —Å–ª–æ–≤–æ–º üëá</div>
        <div class="toast" id="toast">+20</div>

        <div class="rail">
          <div class="power" id="pFreeze">
            <div>
              <div class="name">‚ùÑÔ∏è Freeze</div>
              <small>–∑–∞–º–µ–¥–ª–∏—Ç—å –ø–ª–∏—Ç–∫–∏</small>
            </div>
            <div class="cnt" id="cFreeze">2</div>
          </div>
          <div class="power" id="pBomb">
            <div>
              <div class="name">üí£ Bomb</div>
              <small>—É–±—Ä–∞—Ç—å 2 –ª–∏—à–Ω–∏—Ö</small>
            </div>
            <div class="cnt" id="cBomb">2</div>
          </div>
          <div class="power" id="pShield">
            <div>
              <div class="name">üõ°Ô∏è Shield</div>
              <small>1 –æ—à–∏–±–∫–∞ –±–µ–∑ —Å–±—Ä–æ—Å–∞</small>
            </div>
            <div class="cnt" id="cShield">1</div>
          </div>
        </div>
      </div>

      <div class="bottom">
        <div class="stat">–†–∞—É–Ω–¥: <b id="round">1</b></div>
        <div class="stat">–û—à–∏–±–∫–∏: <b id="mist">0</b></div>
        <button class="btnGhost" id="restart">–ù–æ–≤—ã–π —Ä–∞–Ω ‚Üª</button>
      </div>
    </div>

    <div class="modalBack" id="modalBack">
      <div class="modal">
        <div class="modalHead">
          <h2>Pro ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–Ω–æ ‚ú®</h2>
          <button class="x" id="closeModal">‚úï</button>
        </div>
        <div class="modalBody">
          –¢—É—Ç —Ä–µ–∞–ª—å–Ω–æ –≤–∏–¥–Ω–æ, –∑–∞ —á—Ç–æ –ø–ª–∞—Ç–∏—Ç—å: –≤ Pro —Ç—ã –∏–≥—Ä–∞–µ—à—å –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å –Ω–æ–≤—ã–µ –Ω–∞–±–æ—Ä—ã.
          <div class="plans">
            <div class="plan"><div><b>‚àû –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–∞–Ω—ã</b><div class="k">–±–µ–∑ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞</div></div><div class="badge"><b>‚Ç¨2.99</b></div></div>
            <div class="plan"><div><b>–ù–æ–≤—ã–µ –ø–∞–∫–∏</b><div class="k">—Ü–≤–µ—Ç–∞, —Ç–µ–º—ã, —è–∑—ã–∫–∏</div></div><div class="badge"><b>‚Ç¨1.99</b></div></div>
            <div class="plan"><div><b>–¢—É—Ä–Ω–∏—Ä—ã</b><div class="k">–ª–∏–¥–µ—Ä–±–æ—Ä–¥ –≤ –≥—Ä—É–ø–ø–µ</div></div><div class="badge"><b>‚Ç¨1.49</b></div></div>
          </div>
          <button class="cta" id="buyBtn">–û—Ç–∫—Ä—ã—Ç—å Pro (–¥–µ–º–æ)</button>
          <div class="k" style="margin-top:10px;">–°–µ–π—á–∞—Å –∫–Ω–æ–ø–∫–∞ ‚Äî –¥–µ–º–æ. –ü–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏—à—å –æ–ø–ª–∞—Ç—É.</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Telegram init safe
    const tg = window.Telegram?.WebApp;
    try { tg?.ready(); tg?.expand(); } catch(e){}

    // Data pack (easy to replace with other packs/languages)
    const data = [
      { n: 0, a: "z√©ro" }, { n: 1, a: "un" }, { n: 2, a: "deux" }, { n: 3, a: "trois" },
      { n: 4, a: "quatre" }, { n: 5, a: "cinq" }, { n: 6, a: "six" }, { n: 7, a: "sept" },
      { n: 8, a: "huit" }, { n: 9, a: "neuf" }, { n: 10, a: "dix" }
    ];

    // --- State ---
    let score = 0;
    let combo = 0;
    let mult = 1;
    let round = 1;
    let mistakes = 0;

    // Boss cadence
    const BOSS_EVERY = 5; // every 5 rounds
    let toBoss = BOSS_EVERY;

    // Powerups
    let freeze = 2;
    let bomb = 2;
    let shield = 1;
    let shieldArmed = false;

    // Speed scaling
    let speed = 62; // px/sec
    let spawnMs = 900;

    // Monetization demo: limit free runs/day
    const FREE_RUNS = 2;
    const RUN_KEY = "lg_wr_runs";
    const DAY_KEY = "lg_wr_day";

    // Daily best (habit loop)
    const BEST_KEY = "lg_wr_best";
    const today = () => {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    };

    function ensureDay(){
      const t = today();
      const sd = localStorage.getItem(DAY_KEY);
      if(sd !== t){
        localStorage.setItem(DAY_KEY, t);
        localStorage.setItem(RUN_KEY, "0");
      }
    }

    ensureDay();

    // --- UI ---
    const arena = document.getElementById("arena");
    const elTargetNum = document.getElementById("targetNum");
    const elScore = document.getElementById("score");
    const elCombo = document.getElementById("combo");
    const elMult = document.getElementById("mult");
    const elRound = document.getElementById("round");
    const elMist = document.getElementById("mist");
    const elToBoss = document.getElementById("toBoss");
    const bossBar = document.getElementById("bossBar");
    const toast = document.getElementById("toast");
    const hint = document.getElementById("hint");

    const cFreeze = document.getElementById("cFreeze");
    const cBomb = document.getElementById("cBomb");
    const cShield = document.getElementById("cShield");

    const pFreeze = document.getElementById("pFreeze");
    const pBomb = document.getElementById("pBomb");
    const pShield = document.getElementById("pShield");

    const restartBtn = document.getElementById("restart");
    const soundBtn = document.getElementById("soundBtn");

    const modalBack = document.getElementById("modalBack");
    const closeModal = document.getElementById("closeModal");
    const buyBtn = document.getElementById("buyBtn");

    const dailyBestEl = document.getElementById("dailyBest");

    // --- Sound ---
    let soundOn = true;
    const beep = (freq=520, dur=0.05) => {
      if(!soundOn) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = 0.06;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, dur*1000);
      }catch(e){}
    };

    function vibrate(kind="light"){
      try{
        if(tg?.HapticFeedback){
          if(kind==="success") tg.HapticFeedback.notificationOccurred("success");
          else if(kind==="error") tg.HapticFeedback.notificationOccurred("error");
          else tg.HapticFeedback.impactOccurred("light");
          return;
        }
      }catch(e){}
      if(navigator.vibrate) navigator.vibrate(kind==="error" ? 70 : 25);
    }

    function showToast(text){
      toast.textContent = text;
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"), 520);
    }

    const shuffle = (arr) => arr
      .map(v => ({v, s: Math.random()}))
      .sort((a,b)=>a.s-b.s)
      .map(x=>x.v);

    function pickTarget(){
      return data[Math.floor(Math.random()*data.length)];
    }

    let target = pickTarget();
    elTargetNum.textContent = target.n;

    // --- Tiles engine ---
    let tiles = [];
    let raf = null;
    let spawner = null;
    let lastTs = 0;
    let frozenUntil = 0;

    function setHUD(){
      elScore.textContent = score;
      elCombo.textContent = combo;
      elMult.textContent = mult;
      elRound.textContent = round;
      elMist.textContent = mistakes;

      elToBoss.textContent = toBoss;
      const done = (BOSS_EVERY - toBoss) / BOSS_EVERY;
      bossBar.style.width = `${Math.max(6, Math.min(100, done*100))}%`;

      cFreeze.textContent = freeze;
      cBomb.textContent = bomb;
      cShield.textContent = shield;

      pFreeze.classList.toggle("disabled", freeze<=0);
      pBomb.classList.toggle("disabled", bomb<=0);
      pShield.classList.toggle("disabled", shield<=0 && !shieldArmed);

      // Daily best
      const best = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);
      dailyBestEl.textContent = best;
    }

    function createTile(text, isCorrect){
      const el = document.createElement("div");
      el.className = "tile";
      el.innerHTML = `<b>${text}</b><span class="tag">${isCorrect ? "üéØ target" : "‚ö™ decoy"}</span>`;
      arena.appendChild(el);

      const startY = 110; // below HUD
      const y = startY;
      const w = el.getBoundingClientRect().width;
      const x = arena.getBoundingClientRect().width/2 - w/2;

      const tile = { el, x, y, w, isCorrect, text, alive:true, vy: speed };
      el.style.top = `${y}px`;
      el.style.left = `50%`;
      el.style.transform = `translateX(-50%)`;

      el.addEventListener("click", () => onTileTap(tile), { passive:true });
      tiles.push(tile);
    }

    function spawnBatch(){
      // Boss round: tighter decoys + faster
      const isBoss = (toBoss === 1);

      const correct = target.a;
      const pool = shuffle(data.filter(d=>d.a!==correct)).slice(0, isBoss ? 4 : 3).map(d=>d.a);
      const words = shuffle([correct, ...pool]);

      // spawn as "wave" (arcade feel)
      const waveDelay = isBoss ? 140 : 180;

      words.forEach((w, i) => {
        setTimeout(()=> createTile(w, w===correct), i*waveDelay);
      });

      hint.textContent = isBoss ? "–ë–æ—Å—Å-–≤–æ–ª–Ω–∞: –Ω–µ –æ—à–∏–±–∏—Å—å üòà" : "–¢–∞–ø–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–ª–∏—Ç–∫—É üëá";
    }

    function clearTiles(){
      tiles.forEach(t => { if(t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); });
      tiles = [];
    }

    function onTileTap(tile){
      if(!tile.alive) return;
      tile.alive = false;

      // Visual mark
      tile.el.classList.add(tile.isCorrect ? "good" : "bad");

      if(tile.isCorrect){
        // score with speed + combo
        combo++;
        mult = 1 + Math.floor(combo/4);
        const bonus = Math.min(20, Math.round((tile.vy / 62) * 8));
        const gained = 10*mult + bonus;
        score += gained;

        showToast(`+${gained}`);
        beep(740, .05);
        vibrate("success");

        // next target/round
        setTimeout(()=> {
          nextRound();
        }, 220);

      } else {
        // wrong
        mistakes++;
        beep(220, .07);
        vibrate("error");

        if(shieldArmed){
          shieldArmed = false;
          showToast("üõ°Ô∏è Shield —Å–ø–∞—Å");
          // keep combo
        } else {
          combo = 0; mult = 1;
          showToast("–ú–∏–Ω—É—Å –∫–æ–º–±–æ");
        }

        // remove this tile, keep others
        setTimeout(()=> {
          if(tile.el && tile.el.parentNode) tile.el.parentNode.removeChild(tile.el);
        }, 160);
      }

      setHUD();
    }

    function nextRound(){
      round++;
      toBoss--;
      if(toBoss <= 0) toBoss = BOSS_EVERY;

      // difficulty scaling
      speed = Math.min(140, speed + 3.2);
      spawnMs = Math.max(520, spawnMs - 18);

      target = pickTarget();
      elTargetNum.textContent = target.n;

      clearTiles();
      spawnBatch();
      setHUD();
    }

    function tick(ts){
      if(!lastTs) lastTs = ts;
      const dt = (ts - lastTs)/1000;
      lastTs = ts;

      const frozen = (performance.now() < frozenUntil);
      const k = frozen ? 0.35 : 1;

      const h = arena.getBoundingClientRect().height;
      tiles.forEach(t => {
        if(!t.alive) return;
        t.y += t.vy * dt * k;
        t.el.style.top = `${t.y}px`;

        // If tile falls too low -> it's a miss (counts like mistake if it was correct)
        if(t.y > h - 92){
          t.alive = false;
          if(t.isCorrect){
            mistakes++;
            if(shieldArmed){
              shieldArmed = false;
              showToast("üõ°Ô∏è Shield —Å–ø–∞—Å (–ø—Ä–æ–ø—É—Å–∫)");
            } else {
              combo = 0; mult = 1;
              showToast("–ü—Ä–æ–º–∞—Ö");
            }
            beep(220, .07);
            vibrate("error");
            setHUD();
          }
          if(t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el);
        }
      });

      raf = requestAnimationFrame(tick);
    }

    function start(){
      clearTiles();
      lastTs = 0;
      spawnBatch();
      setHUD();
      raf = requestAnimationFrame(tick);

      clearInterval(spawner);
      spawner = setInterval(() => {
        // if arena has too few tiles, spawn new wave
        const alive = tiles.filter(t=>t.alive).length;
        if(alive <= 1) spawnBatch();
      }, spawnMs);
    }

    function stop(){
      cancelAnimationFrame(raf);
      clearInterval(spawner);
    }

    // Powerups
    pFreeze.onclick = () => {
      if(freeze<=0) return;
      freeze--;
      frozenUntil = performance.now() + 2500;
      showToast("‚ùÑÔ∏è Freeze");
      beep(600, .05);
      vibrate("light");
      setHUD();
    };

    pBomb.onclick = () => {
      if(bomb<=0) return;
      bomb--;

      // remove up to 2 wrong tiles alive
      let removed = 0;
      tiles.forEach(t => {
        if(removed>=2) return;
        if(t.alive && !t.isCorrect){
          t.alive = false;
          removed++;
          t.el.classList.add("bad");
          setTimeout(()=>{ if(t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); }, 140);
        }
      });

      showToast("üí£ -2 –ª–æ–∂–Ω—ã—Ö");
      beep(520, .05);
      vibrate("light");
      setHUD();
    };

    pShield.onclick = () => {
      if(shield<=0 && !shieldArmed) return;
      if(!shieldArmed){
        shield--;
        shieldArmed = true;
        showToast("üõ°Ô∏è Shield –≥–æ—Ç–æ–≤");
        beep(680, .05);
      } else {
        // toggle off
        shieldArmed = false;
        showToast("Shield —Å–Ω—è—Ç");
      }
      vibrate("light");
      setHUD();
    };

    // Restart / Sound
    restartBtn.onclick = () => {
      // monetization demo: free runs/day
      ensureDay();
      const runs = parseInt(localStorage.getItem(RUN_KEY) || "0", 10);
      if(runs >= FREE_RUNS){
        modalBack.classList.add("show");
        return;
      }
      localStorage.setItem(RUN_KEY, String(runs+1));

      // save daily best
      const best = parseInt(localStorage.getItem(BEST_KEY) || "0", 10);
      if(score > best) localStorage.setItem(BEST_KEY, String(score));

      // reset
      score=0; combo=0; mult=1; round=1; mistakes=0;
      toBoss=BOSS_EVERY;
      speed=62; spawnMs=900;
      freeze=2; bomb=2; shield=1; shieldArmed=false;
      target = pickTarget();
      elTargetNum.textContent = target.n;
      stop(); start();
    };

    soundBtn.onclick = () => {
      soundOn = !soundOn;
      soundBtn.textContent = soundOn ? "üîä" : "üîà";
      showToast(soundOn ? "–ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω" : "–ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω");
    };

    closeModal.onclick = () => modalBack.classList.remove("show");
    buyBtn.onclick = () => {
      showToast("Pro –æ—Ç–∫—Ä—ã—Ç (–¥–µ–º–æ) ‚ú®");
      modalBack.classList.remove("show");
      // let restart without limits in demo
      localStorage.setItem(RUN_KEY, "0");
    };

    // Start game
    start();
  </script>
</body>
</html>
